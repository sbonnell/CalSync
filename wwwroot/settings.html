<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sarasin Exchange Calendar Sync - Settings</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        /* Settings-specific styles */
        .container {
            max-width: 1000px;
        }

        h2 {
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .add-mapping-btn {
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>Settings</h1>
                <p class="subtitle">Configure Exchange Calendar Sync</p>
            </div>
            <div class="nav-links">
                <a href="/" class="nav-link">Dashboard</a>
                <a href="/help.html" class="nav-link">Help</a>
            </div>
        </header>

        <div id="message-area"></div>

        <div id="loading" class="loading">
            <p>Loading settings...</p>
        </div>

        <form id="settings-form" style="display: none;">
            <!-- Sync Settings -->
            <div class="card">
                <h2>Sync Settings</h2>
                <p class="section-description">Configure how often and how far back/forward to sync calendar items.</p>
                <div class="form-row">
                    <div class="form-group">
                        <label for="syncInterval">Sync Interval (minutes)</label>
                        <input type="number" id="syncInterval" name="syncInterval" min="1" max="1440" value="5">
                    </div>
                    <div class="form-group">
                        <label for="lookbackDays">Look Back Days</label>
                        <input type="number" id="lookbackDays" name="lookbackDays" min="1" max="365" value="30">
                    </div>
                    <div class="form-group">
                        <label for="lookForwardDays">Look Forward Days</label>
                        <input type="number" id="lookForwardDays" name="lookForwardDays" min="1" max="365" value="30">
                    </div>
                </div>
            </div>

            <!-- Exchange On-Premise Settings -->
            <div class="card">
                <h2>Exchange On-Premise (Source)</h2>
                <p class="section-description">Configure connection to Exchange On-Premise server via EWS. Only required if using Exchange On-Premise as a source.</p>
                <div class="form-row">
                    <div class="form-group">
                        <label for="onPremServerUrl">Server URL</label>
                        <input type="text" id="onPremServerUrl" name="onPremServerUrl" placeholder="https://exchange.domain.com/EWS/Exchange.asmx">
                    </div>
                    <div class="form-group">
                        <label for="onPremDomain">Domain</label>
                        <input type="text" id="onPremDomain" name="onPremDomain" placeholder="DOMAIN">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="onPremUsername">Username</label>
                        <input type="text" id="onPremUsername" name="onPremUsername" placeholder="service_account">
                    </div>
                    <div class="form-group">
                        <label for="onPremPassword">Password</label>
                        <div class="password-field">
                            <input type="password" id="onPremPassword" name="onPremPassword" placeholder="Leave blank to keep existing">
                            <button type="button" class="password-toggle" onclick="togglePassword('onPremPassword')">Show</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Exchange Online Source Settings -->
            <div class="card">
                <h2>Exchange Online Source</h2>
                <p class="section-description">Configure connection to Exchange Online as a source via Microsoft Graph API. Only required if using Exchange Online as a source.</p>
                <div class="form-row">
                    <div class="form-group">
                        <label for="onlineSourceTenantId">Tenant ID</label>
                        <input type="text" id="onlineSourceTenantId" name="onlineSourceTenantId" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
                    </div>
                    <div class="form-group">
                        <label for="onlineSourceClientId">Client ID</label>
                        <input type="text" id="onlineSourceClientId" name="onlineSourceClientId" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
                    </div>
                </div>
                <div class="form-group">
                    <label for="onlineSourceClientSecret">Client Secret</label>
                    <div class="password-field">
                        <input type="password" id="onlineSourceClientSecret" name="onlineSourceClientSecret" placeholder="Leave blank to keep existing">
                        <button type="button" class="password-toggle" onclick="togglePassword('onlineSourceClientSecret')">Show</button>
                    </div>
                </div>
            </div>

            <!-- Exchange Online Destination Settings -->
            <div class="card">
                <h2>Exchange Online Destination</h2>
                <p class="section-description">Configure connection to Exchange Online as the destination via Microsoft Graph API. This is always required.</p>
                <div class="form-row">
                    <div class="form-group">
                        <label for="onlineTenantId">Tenant ID</label>
                        <input type="text" id="onlineTenantId" name="onlineTenantId" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
                    </div>
                    <div class="form-group">
                        <label for="onlineClientId">Client ID</label>
                        <input type="text" id="onlineClientId" name="onlineClientId" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
                    </div>
                </div>
                <div class="form-group">
                    <label for="onlineClientSecret">Client Secret</label>
                    <div class="password-field">
                        <input type="password" id="onlineClientSecret" name="onlineClientSecret" placeholder="Leave blank to keep existing">
                        <button type="button" class="password-toggle" onclick="togglePassword('onlineClientSecret')">Show</button>
                    </div>
                </div>
            </div>

            <!-- Mailbox Mappings -->
            <div class="card">
                <h2>Mailbox Mappings</h2>
                <p class="section-description">Configure which source mailboxes sync to which destination mailboxes. The Name field is used for filtering logs in the dashboard.</p>

                <div id="mappings-container" class="mapping-list">
                    <!-- Mappings will be dynamically added here -->
                </div>

                <button type="button" class="btn btn-success add-mapping-btn" onclick="addMapping()">+ Add Mailbox Mapping</button>
            </div>

            <!-- Persistence Settings -->
            <div class="card">
                <h2>Persistence Settings</h2>
                <p class="section-description">Configure state persistence for tracking sync history.</p>
                <div class="form-row">
                    <div class="form-group">
                        <label for="dataPath">Data Path</label>
                        <input type="text" id="dataPath" name="dataPath" placeholder="./data">
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="enableStatePersistence" name="enableStatePersistence">
                            Enable State Persistence
                        </label>
                    </div>
                </div>
            </div>

            <!-- OpenTelemetry Settings -->
            <div class="card">
                <h2>OpenTelemetry Settings</h2>
                <p class="section-description">Configure OpenTelemetry export for logs and metrics to an OTLP collector.</p>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="otelEnabled" name="otelEnabled">
                        Enable OpenTelemetry Export
                    </label>
                </div>

                <div id="otel-settings" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="otelEndpoint">OTLP Endpoint</label>
                            <input type="text" id="otelEndpoint" name="otelEndpoint" placeholder="http://otel-collector:4317">
                        </div>
                        <div class="form-group">
                            <label for="otelProtocol">Protocol</label>
                            <select id="otelProtocol" name="otelProtocol">
                                <option value="grpc">gRPC (port 4317)</option>
                                <option value="http">HTTP/Protobuf (port 4318)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="otelServiceName">Service Name</label>
                            <input type="text" id="otelServiceName" name="otelServiceName" placeholder="exchange-calendar-sync">
                        </div>
                        <div class="form-group">
                            <label for="otelEnvironment">Environment</label>
                            <input type="text" id="otelEnvironment" name="otelEnvironment" placeholder="production">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="otelExportLogs" name="otelExportLogs" checked>
                                Export Logs
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="otelExportMetrics" name="otelExportMetrics" checked>
                                Export Metrics
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="otelMetricsInterval">Metrics Interval (seconds)</label>
                            <input type="number" id="otelMetricsInterval" name="otelMetricsInterval" min="10" max="300" value="60">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="otelHeaders">Authentication Headers (optional)</label>
                        <div class="password-field">
                            <input type="password" id="otelHeaders" name="otelHeaders" placeholder="api-key=xxx,x-custom=value (leave blank to keep existing)">
                            <button type="button" class="password-toggle" onclick="togglePassword('otelHeaders')">Show</button>
                        </div>
                        <small style="color: #666; display: block; margin-top: 5px;">Comma-separated key=value pairs for OTLP authentication</small>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="button-group">
                <button type="submit" class="btn btn-primary">Save Settings</button>
                <button type="button" class="btn btn-secondary" onclick="loadSettings()">Reset Changes</button>
            </div>
        </form>
    </div>

    <script src="/js/common.js"></script>
    <script src="/js/settings.js"></script>
</body>
</html>
